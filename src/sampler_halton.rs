use std::cmp::min;

use bbox::BBox2i;
use common::ONE_MINUS_EPSILON;
use sampler::Sampler;
use vector::{Point2u, Point2i, Point2f};

/// Max resolution of one tile.
const K_MAX_RESOLUTION: i32 = 128;

#[derive(Clone)]
pub struct HaltonSampler {
    // General sampler
    samples_per_pixel: u32,

    current_pixel: Point2i,
    current_pixel_sample_index: u32,

    // Global sampler
    // Next dimension
    dimension: u32,
    // Index of sample in current pixel
    interval_sample_index: u32,

    // Halton sampler
    base_scale: Point2u,
    base_exp: Point2u,
    sample_stride: u32,
    pixel_for_offset: Point2i,
    // First sample in the current_pixel
    offset_for_current_pixel: u32,
    mul_inverse: [u32; 2],
}

impl HaltonSampler {
    pub fn new(samples_per_pixel: u32, sample_bbox: BBox2i) -> HaltonSampler {
        let res = sample_bbox.diagonal();
        let mut base_scale = Point2u::default();
        let mut base_exp = Point2u::default();
        for i in 0..2 {
            let base = if i == 0 { 2 } else { 3 };
            let mut scale = 1;
            let mut exp = 0;
            while scale < min(res[i], K_MAX_RESOLUTION) as u32 {
                scale *= base;
                exp += 1;
            }
            base_scale[i] = scale;
            base_exp[i] = exp;
        }
        let sample_stride = base_scale[0] * base_scale[1];
        let mul_inverse = [
            multiplicative_inverse(base_scale[1], base_scale[0]),
            multiplicative_inverse(base_scale[0], base_scale[1]),
        ];
        return HaltonSampler {
            samples_per_pixel,

            current_pixel: Point2i::default(),
            current_pixel_sample_index: 0,

            dimension: 0,
            interval_sample_index: 0,

            base_scale,
            base_exp,
            sample_stride,
            pixel_for_offset: Point2i::default(),
            offset_for_current_pixel: 0,
            mul_inverse,
        };
    }

    /// Return index to the sample in the overall set of samples based on current pixel and sample index.
    fn get_index_for_sample(&mut self) -> u32 {
        if self.pixel_for_offset != self.current_pixel {
            self.offset_for_current_pixel = 0;
            if self.sample_stride > 1 {
                let pm = Point2u::new(
                    pos_mod(self.current_pixel.x, K_MAX_RESOLUTION),
                    pos_mod(self.current_pixel.y, K_MAX_RESOLUTION),
                );
                for i in 0..2 {
                    let base = if i == 0 { 2 } else { 3 };
                    let dim_offset = inverse_radical_inverse(base, pm[i], self.base_exp[i]);
                    self.offset_for_current_pixel +=
                        dim_offset * (self.sample_stride / self.base_scale[i]) * self.mul_inverse[i];
                }
                self.offset_for_current_pixel %= self.sample_stride;
            }

            self.pixel_for_offset = self.current_pixel;
        }
        return self.offset_for_current_pixel + self.current_pixel_sample_index * self.sample_stride;
    }

    /// Return sample value for the given dimension of the indexth sample in the overall set of samples.
    fn sample_dimension(&self, index: u32, d: u32) -> f32 {
        match d {
            0 => radical_inverse_prime(0, index >> self.base_exp.x),
            1 => radical_inverse_prime(1, index / self.base_scale.y),
            _ => radical_inverse_prime(d, index),
        }
    }
}

impl Sampler for HaltonSampler {
    fn start_pixel(&mut self, p: Point2i) {
        // General sampler
        self.current_pixel = p;
        self.current_pixel_sample_index = 0;

        // Global sampler
        self.dimension = 0;
        self.interval_sample_index = self.get_index_for_sample();
    }

    fn start_next_sample(&mut self) -> bool {
        self.current_pixel_sample_index += 1;

        self.dimension = 0;
        self.interval_sample_index = self.get_index_for_sample();

        return self.current_pixel_sample_index < self.samples_per_pixel;
    }

    fn get_1d(&mut self) -> f32 {
        let sample =
            self.sample_dimension(self.interval_sample_index, self.dimension);
        self.dimension += 1;
        return sample;
    }

    fn get_2d(&mut self) -> Point2f {
        let sample = Point2f::new(
            self.sample_dimension(self.interval_sample_index, self.dimension),
            self.sample_dimension(self.interval_sample_index, self.dimension + 1),
        );
        self.dimension += 2;
        return sample;
    }
}

fn radical_inverse(base: u32, mut a: u32) -> f32 {
    let mut x = 0;
    let mut base_n = 1;
    while a > 0 {
        x = x * base + a % base;
        a /= base;
        base_n *= base;
    }
    return ONE_MINUS_EPSILON.min(x as f32 / base_n as f32);
}

fn radical_inverse_prime(base_index: u32, a: u32) -> f32 {
    match base_index {
        00 => radical_inverse(2, a),
        01 => radical_inverse(3, a),
        02 => radical_inverse(5, a),
        03 => radical_inverse(7, a),
        04 => radical_inverse(11, a),
        05 => radical_inverse(13, a),
        06 => radical_inverse(17, a),
        07 => radical_inverse(19, a),
        08 => radical_inverse(23, a),
        09 => radical_inverse(29, a),
        10 => radical_inverse(31, a),
        11 => radical_inverse(37, a),
        12 => radical_inverse(41, a),
        13 => radical_inverse(43, a),
        14 => radical_inverse(47, a),
        15 => radical_inverse(53, a),
        16 => radical_inverse(59, a),
        17 => radical_inverse(61, a),
        18 => radical_inverse(67, a),
        19 => radical_inverse(71, a),
        20 => radical_inverse(73, a),
        21 => radical_inverse(79, a),
        22 => radical_inverse(83, a),
        23 => radical_inverse(89, a),
        24 => radical_inverse(97, a),
        25 => radical_inverse(101, a),
        26 => radical_inverse(103, a),
        27 => radical_inverse(107, a),
        28 => radical_inverse(109, a),
        29 => radical_inverse(113, a),
        30 => radical_inverse(127, a),
        31 => radical_inverse(131, a),
        32 => radical_inverse(137, a),
        33 => radical_inverse(139, a),
        34 => radical_inverse(149, a),
        35 => radical_inverse(151, a),
        36 => radical_inverse(157, a),
        37 => radical_inverse(163, a),
        38 => radical_inverse(167, a),
        39 => radical_inverse(173, a),
        40 => radical_inverse(179, a),
        41 => radical_inverse(181, a),
        42 => radical_inverse(191, a),
        43 => radical_inverse(193, a),
        44 => radical_inverse(197, a),
        45 => radical_inverse(199, a),
        46 => radical_inverse(211, a),
        47 => radical_inverse(223, a),
        48 => radical_inverse(227, a),
        49 => radical_inverse(229, a),
        50 => radical_inverse(233, a),
        51 => radical_inverse(239, a),
        52 => radical_inverse(241, a),
        53 => radical_inverse(251, a),
        54 => radical_inverse(257, a),
        55 => radical_inverse(263, a),
        56 => radical_inverse(269, a),
        57 => radical_inverse(271, a),
        58 => radical_inverse(277, a),
        59 => radical_inverse(281, a),
        60 => radical_inverse(283, a),
        61 => radical_inverse(293, a),
        62 => radical_inverse(307, a),
        63 => radical_inverse(311, a),
        64 => radical_inverse(313, a),
        65 => radical_inverse(317, a),
        66 => radical_inverse(331, a),
        67 => radical_inverse(337, a),
        68 => radical_inverse(347, a),
        69 => radical_inverse(349, a),
        70 => radical_inverse(353, a),
        71 => radical_inverse(359, a),
        72 => radical_inverse(367, a),
        73 => radical_inverse(373, a),
        74 => radical_inverse(379, a),
        75 => radical_inverse(383, a),
        76 => radical_inverse(389, a),
        77 => radical_inverse(397, a),
        78 => radical_inverse(401, a),
        79 => radical_inverse(409, a),
        80 => radical_inverse(419, a),
        81 => radical_inverse(421, a),
        82 => radical_inverse(431, a),
        83 => radical_inverse(433, a),
        84 => radical_inverse(439, a),
        85 => radical_inverse(443, a),
        86 => radical_inverse(449, a),
        87 => radical_inverse(457, a),
        88 => radical_inverse(461, a),
        89 => radical_inverse(463, a),
        90 => radical_inverse(467, a),
        91 => radical_inverse(479, a),
        92 => radical_inverse(487, a),
        93 => radical_inverse(491, a),
        94 => radical_inverse(499, a),
        95 => radical_inverse(503, a),
        96 => radical_inverse(509, a),
        97 => radical_inverse(521, a),
        98 => radical_inverse(523, a),
        99 => radical_inverse(541, a),
        100 => radical_inverse(547, a),
        101 => radical_inverse(557, a),
        102 => radical_inverse(563, a),
        103 => radical_inverse(569, a),
        104 => radical_inverse(571, a),
        105 => radical_inverse(577, a),
        106 => radical_inverse(587, a),
        107 => radical_inverse(593, a),
        108 => radical_inverse(599, a),
        109 => radical_inverse(601, a),
        110 => radical_inverse(607, a),
        111 => radical_inverse(613, a),
        112 => radical_inverse(617, a),
        113 => radical_inverse(619, a),
        114 => radical_inverse(631, a),
        115 => radical_inverse(641, a),
        116 => radical_inverse(643, a),
        117 => radical_inverse(647, a),
        118 => radical_inverse(653, a),
        119 => radical_inverse(659, a),
        120 => radical_inverse(661, a),
        121 => radical_inverse(673, a),
        122 => radical_inverse(677, a),
        123 => radical_inverse(683, a),
        124 => radical_inverse(691, a),
        125 => radical_inverse(701, a),
        126 => radical_inverse(709, a),
        127 => radical_inverse(719, a),
        128 => radical_inverse(727, a),
        129 => radical_inverse(733, a),
        130 => radical_inverse(739, a),
        131 => radical_inverse(743, a),
        132 => radical_inverse(751, a),
        133 => radical_inverse(757, a),
        134 => radical_inverse(761, a),
        135 => radical_inverse(769, a),
        136 => radical_inverse(773, a),
        137 => radical_inverse(787, a),
        138 => radical_inverse(797, a),
        139 => radical_inverse(809, a),
        140 => radical_inverse(811, a),
        141 => radical_inverse(821, a),
        142 => radical_inverse(823, a),
        143 => radical_inverse(827, a),
        144 => radical_inverse(829, a),
        145 => radical_inverse(839, a),
        146 => radical_inverse(853, a),
        147 => radical_inverse(857, a),
        148 => radical_inverse(859, a),
        149 => radical_inverse(863, a),
        150 => radical_inverse(877, a),
        151 => radical_inverse(881, a),
        152 => radical_inverse(883, a),
        153 => radical_inverse(887, a),
        154 => radical_inverse(907, a),
        155 => radical_inverse(911, a),
        156 => radical_inverse(919, a),
        157 => radical_inverse(929, a),
        158 => radical_inverse(937, a),
        159 => radical_inverse(941, a),
        160 => radical_inverse(947, a),
        161 => radical_inverse(953, a),
        162 => radical_inverse(967, a),
        163 => radical_inverse(971, a),
        164 => radical_inverse(977, a),
        165 => radical_inverse(983, a),
        166 => radical_inverse(991, a),
        167 => radical_inverse(997, a),
        168 => radical_inverse(1009, a),
        169 => radical_inverse(1013, a),
        170 => radical_inverse(1019, a),
        171 => radical_inverse(1021, a),
        172 => radical_inverse(1031, a),
        173 => radical_inverse(1033, a),
        174 => radical_inverse(1039, a),
        175 => radical_inverse(1049, a),
        176 => radical_inverse(1051, a),
        177 => radical_inverse(1061, a),
        178 => radical_inverse(1063, a),
        179 => radical_inverse(1069, a),
        180 => radical_inverse(1087, a),
        181 => radical_inverse(1091, a),
        182 => radical_inverse(1093, a),
        183 => radical_inverse(1097, a),
        184 => radical_inverse(1103, a),
        185 => radical_inverse(1109, a),
        186 => radical_inverse(1117, a),
        187 => radical_inverse(1123, a),
        188 => radical_inverse(1129, a),
        189 => radical_inverse(1151, a),
        190 => radical_inverse(1153, a),
        191 => radical_inverse(1163, a),
        192 => radical_inverse(1171, a),
        193 => radical_inverse(1181, a),
        194 => radical_inverse(1187, a),
        195 => radical_inverse(1193, a),
        196 => radical_inverse(1201, a),
        197 => radical_inverse(1213, a),
        198 => radical_inverse(1217, a),
        199 => radical_inverse(1223, a),
        200 => radical_inverse(1229, a),
        201 => radical_inverse(1231, a),
        202 => radical_inverse(1237, a),
        203 => radical_inverse(1249, a),
        204 => radical_inverse(1259, a),
        205 => radical_inverse(1277, a),
        206 => radical_inverse(1279, a),
        207 => radical_inverse(1283, a),
        208 => radical_inverse(1289, a),
        209 => radical_inverse(1291, a),
        210 => radical_inverse(1297, a),
        211 => radical_inverse(1301, a),
        212 => radical_inverse(1303, a),
        213 => radical_inverse(1307, a),
        214 => radical_inverse(1319, a),
        215 => radical_inverse(1321, a),
        216 => radical_inverse(1327, a),
        217 => radical_inverse(1361, a),
        218 => radical_inverse(1367, a),
        219 => radical_inverse(1373, a),
        220 => radical_inverse(1381, a),
        221 => radical_inverse(1399, a),
        222 => radical_inverse(1409, a),
        223 => radical_inverse(1423, a),
        224 => radical_inverse(1427, a),
        225 => radical_inverse(1429, a),
        226 => radical_inverse(1433, a),
        227 => radical_inverse(1439, a),
        228 => radical_inverse(1447, a),
        229 => radical_inverse(1451, a),
        230 => radical_inverse(1453, a),
        231 => radical_inverse(1459, a),
        232 => radical_inverse(1471, a),
        233 => radical_inverse(1481, a),
        234 => radical_inverse(1483, a),
        235 => radical_inverse(1487, a),
        236 => radical_inverse(1489, a),
        237 => radical_inverse(1493, a),
        238 => radical_inverse(1499, a),
        239 => radical_inverse(1511, a),
        240 => radical_inverse(1523, a),
        241 => radical_inverse(1531, a),
        242 => radical_inverse(1543, a),
        243 => radical_inverse(1549, a),
        244 => radical_inverse(1553, a),
        245 => radical_inverse(1559, a),
        246 => radical_inverse(1567, a),
        247 => radical_inverse(1571, a),
        248 => radical_inverse(1579, a),
        249 => radical_inverse(1583, a),
        250 => radical_inverse(1597, a),
        251 => radical_inverse(1601, a),
        252 => radical_inverse(1607, a),
        253 => radical_inverse(1609, a),
        254 => radical_inverse(1613, a),
        255 => radical_inverse(1619, a),
        256 => radical_inverse(1621, a),
        257 => radical_inverse(1627, a),
        258 => radical_inverse(1637, a),
        259 => radical_inverse(1657, a),
        260 => radical_inverse(1663, a),
        261 => radical_inverse(1667, a),
        262 => radical_inverse(1669, a),
        263 => radical_inverse(1693, a),
        264 => radical_inverse(1697, a),
        265 => radical_inverse(1699, a),
        266 => radical_inverse(1709, a),
        267 => radical_inverse(1721, a),
        268 => radical_inverse(1723, a),
        269 => radical_inverse(1733, a),
        270 => radical_inverse(1741, a),
        271 => radical_inverse(1747, a),
        272 => radical_inverse(1753, a),
        273 => radical_inverse(1759, a),
        274 => radical_inverse(1777, a),
        275 => radical_inverse(1783, a),
        276 => radical_inverse(1787, a),
        277 => radical_inverse(1789, a),
        278 => radical_inverse(1801, a),
        279 => radical_inverse(1811, a),
        280 => radical_inverse(1823, a),
        281 => radical_inverse(1831, a),
        282 => radical_inverse(1847, a),
        283 => radical_inverse(1861, a),
        284 => radical_inverse(1867, a),
        285 => radical_inverse(1871, a),
        286 => radical_inverse(1873, a),
        287 => radical_inverse(1877, a),
        288 => radical_inverse(1879, a),
        289 => radical_inverse(1889, a),
        290 => radical_inverse(1901, a),
        291 => radical_inverse(1907, a),
        292 => radical_inverse(1913, a),
        293 => radical_inverse(1931, a),
        294 => radical_inverse(1933, a),
        295 => radical_inverse(1949, a),
        296 => radical_inverse(1951, a),
        297 => radical_inverse(1973, a),
        298 => radical_inverse(1979, a),
        299 => radical_inverse(1987, a),
        300 => radical_inverse(1993, a),
        301 => radical_inverse(1997, a),
        302 => radical_inverse(1999, a),
        303 => radical_inverse(2003, a),
        304 => radical_inverse(2011, a),
        305 => radical_inverse(2017, a),
        306 => radical_inverse(2027, a),
        307 => radical_inverse(2029, a),
        308 => radical_inverse(2039, a),
        309 => radical_inverse(2053, a),
        310 => radical_inverse(2063, a),
        311 => radical_inverse(2069, a),
        312 => radical_inverse(2081, a),
        313 => radical_inverse(2083, a),
        314 => radical_inverse(2087, a),
        315 => radical_inverse(2089, a),
        316 => radical_inverse(2099, a),
        317 => radical_inverse(2111, a),
        318 => radical_inverse(2113, a),
        319 => radical_inverse(2129, a),
        320 => radical_inverse(2131, a),
        321 => radical_inverse(2137, a),
        322 => radical_inverse(2141, a),
        323 => radical_inverse(2143, a),
        324 => radical_inverse(2153, a),
        325 => radical_inverse(2161, a),
        326 => radical_inverse(2179, a),
        327 => radical_inverse(2203, a),
        328 => radical_inverse(2207, a),
        329 => radical_inverse(2213, a),
        330 => radical_inverse(2221, a),
        331 => radical_inverse(2237, a),
        332 => radical_inverse(2239, a),
        333 => radical_inverse(2243, a),
        334 => radical_inverse(2251, a),
        335 => radical_inverse(2267, a),
        336 => radical_inverse(2269, a),
        337 => radical_inverse(2273, a),
        338 => radical_inverse(2281, a),
        339 => radical_inverse(2287, a),
        340 => radical_inverse(2293, a),
        341 => radical_inverse(2297, a),
        342 => radical_inverse(2309, a),
        343 => radical_inverse(2311, a),
        344 => radical_inverse(2333, a),
        345 => radical_inverse(2339, a),
        346 => radical_inverse(2341, a),
        347 => radical_inverse(2347, a),
        348 => radical_inverse(2351, a),
        349 => radical_inverse(2357, a),
        350 => radical_inverse(2371, a),
        351 => radical_inverse(2377, a),
        352 => radical_inverse(2381, a),
        353 => radical_inverse(2383, a),
        354 => radical_inverse(2389, a),
        355 => radical_inverse(2393, a),
        356 => radical_inverse(2399, a),
        357 => radical_inverse(2411, a),
        358 => radical_inverse(2417, a),
        359 => radical_inverse(2423, a),
        360 => radical_inverse(2437, a),
        361 => radical_inverse(2441, a),
        362 => radical_inverse(2447, a),
        363 => radical_inverse(2459, a),
        364 => radical_inverse(2467, a),
        365 => radical_inverse(2473, a),
        366 => radical_inverse(2477, a),
        367 => radical_inverse(2503, a),
        368 => radical_inverse(2521, a),
        369 => radical_inverse(2531, a),
        370 => radical_inverse(2539, a),
        371 => radical_inverse(2543, a),
        372 => radical_inverse(2549, a),
        373 => radical_inverse(2551, a),
        374 => radical_inverse(2557, a),
        375 => radical_inverse(2579, a),
        376 => radical_inverse(2591, a),
        377 => radical_inverse(2593, a),
        378 => radical_inverse(2609, a),
        379 => radical_inverse(2617, a),
        380 => radical_inverse(2621, a),
        381 => radical_inverse(2633, a),
        382 => radical_inverse(2647, a),
        383 => radical_inverse(2657, a),
        384 => radical_inverse(2659, a),
        385 => radical_inverse(2663, a),
        386 => radical_inverse(2671, a),
        387 => radical_inverse(2677, a),
        388 => radical_inverse(2683, a),
        389 => radical_inverse(2687, a),
        390 => radical_inverse(2689, a),
        391 => radical_inverse(2693, a),
        392 => radical_inverse(2699, a),
        393 => radical_inverse(2707, a),
        394 => radical_inverse(2711, a),
        395 => radical_inverse(2713, a),
        396 => radical_inverse(2719, a),
        397 => radical_inverse(2729, a),
        398 => radical_inverse(2731, a),
        399 => radical_inverse(2741, a),
        400 => radical_inverse(2749, a),
        401 => radical_inverse(2753, a),
        402 => radical_inverse(2767, a),
        403 => radical_inverse(2777, a),
        404 => radical_inverse(2789, a),
        405 => radical_inverse(2791, a),
        406 => radical_inverse(2797, a),
        407 => radical_inverse(2801, a),
        408 => radical_inverse(2803, a),
        409 => radical_inverse(2819, a),
        410 => radical_inverse(2833, a),
        411 => radical_inverse(2837, a),
        412 => radical_inverse(2843, a),
        413 => radical_inverse(2851, a),
        414 => radical_inverse(2857, a),
        415 => radical_inverse(2861, a),
        416 => radical_inverse(2879, a),
        417 => radical_inverse(2887, a),
        418 => radical_inverse(2897, a),
        419 => radical_inverse(2903, a),
        420 => radical_inverse(2909, a),
        421 => radical_inverse(2917, a),
        422 => radical_inverse(2927, a),
        423 => radical_inverse(2939, a),
        424 => radical_inverse(2953, a),
        425 => radical_inverse(2957, a),
        426 => radical_inverse(2963, a),
        427 => radical_inverse(2969, a),
        428 => radical_inverse(2971, a),
        429 => radical_inverse(2999, a),
        430 => radical_inverse(3001, a),
        431 => radical_inverse(3011, a),
        432 => radical_inverse(3019, a),
        433 => radical_inverse(3023, a),
        434 => radical_inverse(3037, a),
        435 => radical_inverse(3041, a),
        436 => radical_inverse(3049, a),
        437 => radical_inverse(3061, a),
        438 => radical_inverse(3067, a),
        439 => radical_inverse(3079, a),
        440 => radical_inverse(3083, a),
        441 => radical_inverse(3089, a),
        442 => radical_inverse(3109, a),
        443 => radical_inverse(3119, a),
        444 => radical_inverse(3121, a),
        445 => radical_inverse(3137, a),
        446 => radical_inverse(3163, a),
        447 => radical_inverse(3167, a),
        448 => radical_inverse(3169, a),
        449 => radical_inverse(3181, a),
        450 => radical_inverse(3187, a),
        451 => radical_inverse(3191, a),
        452 => radical_inverse(3203, a),
        453 => radical_inverse(3209, a),
        454 => radical_inverse(3217, a),
        455 => radical_inverse(3221, a),
        456 => radical_inverse(3229, a),
        457 => radical_inverse(3251, a),
        458 => radical_inverse(3253, a),
        459 => radical_inverse(3257, a),
        460 => radical_inverse(3259, a),
        461 => radical_inverse(3271, a),
        462 => radical_inverse(3299, a),
        463 => radical_inverse(3301, a),
        464 => radical_inverse(3307, a),
        465 => radical_inverse(3313, a),
        466 => radical_inverse(3319, a),
        467 => radical_inverse(3323, a),
        468 => radical_inverse(3329, a),
        469 => radical_inverse(3331, a),
        470 => radical_inverse(3343, a),
        471 => radical_inverse(3347, a),
        472 => radical_inverse(3359, a),
        473 => radical_inverse(3361, a),
        474 => radical_inverse(3371, a),
        475 => radical_inverse(3373, a),
        476 => radical_inverse(3389, a),
        477 => radical_inverse(3391, a),
        478 => radical_inverse(3407, a),
        479 => radical_inverse(3413, a),
        480 => radical_inverse(3433, a),
        481 => radical_inverse(3449, a),
        482 => radical_inverse(3457, a),
        483 => radical_inverse(3461, a),
        484 => radical_inverse(3463, a),
        485 => radical_inverse(3467, a),
        486 => radical_inverse(3469, a),
        487 => radical_inverse(3491, a),
        488 => radical_inverse(3499, a),
        489 => radical_inverse(3511, a),
        490 => radical_inverse(3517, a),
        491 => radical_inverse(3527, a),
        492 => radical_inverse(3529, a),
        493 => radical_inverse(3533, a),
        494 => radical_inverse(3539, a),
        495 => radical_inverse(3541, a),
        496 => radical_inverse(3547, a),
        497 => radical_inverse(3557, a),
        498 => radical_inverse(3559, a),
        499 => radical_inverse(3571, a),
        500 => radical_inverse(3581, a),
        501 => radical_inverse(3583, a),
        502 => radical_inverse(3593, a),
        503 => radical_inverse(3607, a),
        504 => radical_inverse(3613, a),
        505 => radical_inverse(3617, a),
        506 => radical_inverse(3623, a),
        507 => radical_inverse(3631, a),
        508 => radical_inverse(3637, a),
        509 => radical_inverse(3643, a),
        510 => radical_inverse(3659, a),
        511 => radical_inverse(3671, a),
        512 => radical_inverse(3673, a),
        513 => radical_inverse(3677, a),
        514 => radical_inverse(3691, a),
        515 => radical_inverse(3697, a),
        516 => radical_inverse(3701, a),
        517 => radical_inverse(3709, a),
        518 => radical_inverse(3719, a),
        519 => radical_inverse(3727, a),
        520 => radical_inverse(3733, a),
        521 => radical_inverse(3739, a),
        522 => radical_inverse(3761, a),
        523 => radical_inverse(3767, a),
        524 => radical_inverse(3769, a),
        525 => radical_inverse(3779, a),
        526 => radical_inverse(3793, a),
        527 => radical_inverse(3797, a),
        528 => radical_inverse(3803, a),
        529 => radical_inverse(3821, a),
        530 => radical_inverse(3823, a),
        531 => radical_inverse(3833, a),
        532 => radical_inverse(3847, a),
        533 => radical_inverse(3851, a),
        534 => radical_inverse(3853, a),
        535 => radical_inverse(3863, a),
        536 => radical_inverse(3877, a),
        537 => radical_inverse(3881, a),
        538 => radical_inverse(3889, a),
        539 => radical_inverse(3907, a),
        540 => radical_inverse(3911, a),
        541 => radical_inverse(3917, a),
        542 => radical_inverse(3919, a),
        543 => radical_inverse(3923, a),
        544 => radical_inverse(3929, a),
        545 => radical_inverse(3931, a),
        546 => radical_inverse(3943, a),
        547 => radical_inverse(3947, a),
        548 => radical_inverse(3967, a),
        549 => radical_inverse(3989, a),
        550 => radical_inverse(4001, a),
        551 => radical_inverse(4003, a),
        552 => radical_inverse(4007, a),
        553 => radical_inverse(4013, a),
        554 => radical_inverse(4019, a),
        555 => radical_inverse(4021, a),
        556 => radical_inverse(4027, a),
        557 => radical_inverse(4049, a),
        558 => radical_inverse(4051, a),
        559 => radical_inverse(4057, a),
        560 => radical_inverse(4073, a),
        561 => radical_inverse(4079, a),
        562 => radical_inverse(4091, a),
        563 => radical_inverse(4093, a),
        564 => radical_inverse(4099, a),
        565 => radical_inverse(4111, a),
        566 => radical_inverse(4127, a),
        567 => radical_inverse(4129, a),
        568 => radical_inverse(4133, a),
        569 => radical_inverse(4139, a),
        570 => radical_inverse(4153, a),
        571 => radical_inverse(4157, a),
        572 => radical_inverse(4159, a),
        573 => radical_inverse(4177, a),
        574 => radical_inverse(4201, a),
        575 => radical_inverse(4211, a),
        576 => radical_inverse(4217, a),
        577 => radical_inverse(4219, a),
        578 => radical_inverse(4229, a),
        579 => radical_inverse(4231, a),
        580 => radical_inverse(4241, a),
        581 => radical_inverse(4243, a),
        582 => radical_inverse(4253, a),
        583 => radical_inverse(4259, a),
        584 => radical_inverse(4261, a),
        585 => radical_inverse(4271, a),
        586 => radical_inverse(4273, a),
        587 => radical_inverse(4283, a),
        588 => radical_inverse(4289, a),
        589 => radical_inverse(4297, a),
        590 => radical_inverse(4327, a),
        591 => radical_inverse(4337, a),
        592 => radical_inverse(4339, a),
        593 => radical_inverse(4349, a),
        594 => radical_inverse(4357, a),
        595 => radical_inverse(4363, a),
        596 => radical_inverse(4373, a),
        597 => radical_inverse(4391, a),
        598 => radical_inverse(4397, a),
        599 => radical_inverse(4409, a),
        600 => radical_inverse(4421, a),
        601 => radical_inverse(4423, a),
        602 => radical_inverse(4441, a),
        603 => radical_inverse(4447, a),
        604 => radical_inverse(4451, a),
        605 => radical_inverse(4457, a),
        606 => radical_inverse(4463, a),
        607 => radical_inverse(4481, a),
        608 => radical_inverse(4483, a),
        609 => radical_inverse(4493, a),
        610 => radical_inverse(4507, a),
        611 => radical_inverse(4513, a),
        612 => radical_inverse(4517, a),
        613 => radical_inverse(4519, a),
        614 => radical_inverse(4523, a),
        615 => radical_inverse(4547, a),
        616 => radical_inverse(4549, a),
        617 => radical_inverse(4561, a),
        618 => radical_inverse(4567, a),
        619 => radical_inverse(4583, a),
        620 => radical_inverse(4591, a),
        621 => radical_inverse(4597, a),
        622 => radical_inverse(4603, a),
        623 => radical_inverse(4621, a),
        624 => radical_inverse(4637, a),
        625 => radical_inverse(4639, a),
        626 => radical_inverse(4643, a),
        627 => radical_inverse(4649, a),
        628 => radical_inverse(4651, a),
        629 => radical_inverse(4657, a),
        630 => radical_inverse(4663, a),
        631 => radical_inverse(4673, a),
        632 => radical_inverse(4679, a),
        633 => radical_inverse(4691, a),
        634 => radical_inverse(4703, a),
        635 => radical_inverse(4721, a),
        636 => radical_inverse(4723, a),
        637 => radical_inverse(4729, a),
        638 => radical_inverse(4733, a),
        639 => radical_inverse(4751, a),
        640 => radical_inverse(4759, a),
        641 => radical_inverse(4783, a),
        642 => radical_inverse(4787, a),
        643 => radical_inverse(4789, a),
        644 => radical_inverse(4793, a),
        645 => radical_inverse(4799, a),
        646 => radical_inverse(4801, a),
        647 => radical_inverse(4813, a),
        648 => radical_inverse(4817, a),
        649 => radical_inverse(4831, a),
        650 => radical_inverse(4861, a),
        651 => radical_inverse(4871, a),
        652 => radical_inverse(4877, a),
        653 => radical_inverse(4889, a),
        654 => radical_inverse(4903, a),
        655 => radical_inverse(4909, a),
        656 => radical_inverse(4919, a),
        657 => radical_inverse(4931, a),
        658 => radical_inverse(4933, a),
        659 => radical_inverse(4937, a),
        660 => radical_inverse(4943, a),
        661 => radical_inverse(4951, a),
        662 => radical_inverse(4957, a),
        663 => radical_inverse(4967, a),
        664 => radical_inverse(4969, a),
        665 => radical_inverse(4973, a),
        666 => radical_inverse(4987, a),
        667 => radical_inverse(4993, a),
        668 => radical_inverse(4999, a),
        669 => radical_inverse(5003, a),
        670 => radical_inverse(5009, a),
        671 => radical_inverse(5011, a),
        672 => radical_inverse(5021, a),
        673 => radical_inverse(5023, a),
        674 => radical_inverse(5039, a),
        675 => radical_inverse(5051, a),
        676 => radical_inverse(5059, a),
        677 => radical_inverse(5077, a),
        678 => radical_inverse(5081, a),
        679 => radical_inverse(5087, a),
        680 => radical_inverse(5099, a),
        681 => radical_inverse(5101, a),
        682 => radical_inverse(5107, a),
        683 => radical_inverse(5113, a),
        684 => radical_inverse(5119, a),
        685 => radical_inverse(5147, a),
        686 => radical_inverse(5153, a),
        687 => radical_inverse(5167, a),
        688 => radical_inverse(5171, a),
        689 => radical_inverse(5179, a),
        690 => radical_inverse(5189, a),
        691 => radical_inverse(5197, a),
        692 => radical_inverse(5209, a),
        693 => radical_inverse(5227, a),
        694 => radical_inverse(5231, a),
        695 => radical_inverse(5233, a),
        696 => radical_inverse(5237, a),
        697 => radical_inverse(5261, a),
        698 => radical_inverse(5273, a),
        699 => radical_inverse(5279, a),
        700 => radical_inverse(5281, a),
        701 => radical_inverse(5297, a),
        702 => radical_inverse(5303, a),
        703 => radical_inverse(5309, a),
        704 => radical_inverse(5323, a),
        705 => radical_inverse(5333, a),
        706 => radical_inverse(5347, a),
        707 => radical_inverse(5351, a),
        708 => radical_inverse(5381, a),
        709 => radical_inverse(5387, a),
        710 => radical_inverse(5393, a),
        711 => radical_inverse(5399, a),
        712 => radical_inverse(5407, a),
        713 => radical_inverse(5413, a),
        714 => radical_inverse(5417, a),
        715 => radical_inverse(5419, a),
        716 => radical_inverse(5431, a),
        717 => radical_inverse(5437, a),
        718 => radical_inverse(5441, a),
        719 => radical_inverse(5443, a),
        720 => radical_inverse(5449, a),
        721 => radical_inverse(5471, a),
        722 => radical_inverse(5477, a),
        723 => radical_inverse(5479, a),
        724 => radical_inverse(5483, a),
        725 => radical_inverse(5501, a),
        726 => radical_inverse(5503, a),
        727 => radical_inverse(5507, a),
        728 => radical_inverse(5519, a),
        729 => radical_inverse(5521, a),
        730 => radical_inverse(5527, a),
        731 => radical_inverse(5531, a),
        732 => radical_inverse(5557, a),
        733 => radical_inverse(5563, a),
        734 => radical_inverse(5569, a),
        735 => radical_inverse(5573, a),
        736 => radical_inverse(5581, a),
        737 => radical_inverse(5591, a),
        738 => radical_inverse(5623, a),
        739 => radical_inverse(5639, a),
        740 => radical_inverse(5641, a),
        741 => radical_inverse(5647, a),
        742 => radical_inverse(5651, a),
        743 => radical_inverse(5653, a),
        744 => radical_inverse(5657, a),
        745 => radical_inverse(5659, a),
        746 => radical_inverse(5669, a),
        747 => radical_inverse(5683, a),
        748 => radical_inverse(5689, a),
        749 => radical_inverse(5693, a),
        750 => radical_inverse(5701, a),
        751 => radical_inverse(5711, a),
        752 => radical_inverse(5717, a),
        753 => radical_inverse(5737, a),
        754 => radical_inverse(5741, a),
        755 => radical_inverse(5743, a),
        756 => radical_inverse(5749, a),
        757 => radical_inverse(5779, a),
        758 => radical_inverse(5783, a),
        759 => radical_inverse(5791, a),
        760 => radical_inverse(5801, a),
        761 => radical_inverse(5807, a),
        762 => radical_inverse(5813, a),
        763 => radical_inverse(5821, a),
        764 => radical_inverse(5827, a),
        765 => radical_inverse(5839, a),
        766 => radical_inverse(5843, a),
        767 => radical_inverse(5849, a),
        768 => radical_inverse(5851, a),
        769 => radical_inverse(5857, a),
        770 => radical_inverse(5861, a),
        771 => radical_inverse(5867, a),
        772 => radical_inverse(5869, a),
        773 => radical_inverse(5879, a),
        774 => radical_inverse(5881, a),
        775 => radical_inverse(5897, a),
        776 => radical_inverse(5903, a),
        777 => radical_inverse(5923, a),
        778 => radical_inverse(5927, a),
        779 => radical_inverse(5939, a),
        780 => radical_inverse(5953, a),
        781 => radical_inverse(5981, a),
        782 => radical_inverse(5987, a),
        783 => radical_inverse(6007, a),
        784 => radical_inverse(6011, a),
        785 => radical_inverse(6029, a),
        786 => radical_inverse(6037, a),
        787 => radical_inverse(6043, a),
        788 => radical_inverse(6047, a),
        789 => radical_inverse(6053, a),
        790 => radical_inverse(6067, a),
        791 => radical_inverse(6073, a),
        792 => radical_inverse(6079, a),
        793 => radical_inverse(6089, a),
        794 => radical_inverse(6091, a),
        795 => radical_inverse(6101, a),
        796 => radical_inverse(6113, a),
        797 => radical_inverse(6121, a),
        798 => radical_inverse(6131, a),
        799 => radical_inverse(6133, a),
        800 => radical_inverse(6143, a),
        801 => radical_inverse(6151, a),
        802 => radical_inverse(6163, a),
        803 => radical_inverse(6173, a),
        804 => radical_inverse(6197, a),
        805 => radical_inverse(6199, a),
        806 => radical_inverse(6203, a),
        807 => radical_inverse(6211, a),
        808 => radical_inverse(6217, a),
        809 => radical_inverse(6221, a),
        810 => radical_inverse(6229, a),
        811 => radical_inverse(6247, a),
        812 => radical_inverse(6257, a),
        813 => radical_inverse(6263, a),
        814 => radical_inverse(6269, a),
        815 => radical_inverse(6271, a),
        816 => radical_inverse(6277, a),
        817 => radical_inverse(6287, a),
        818 => radical_inverse(6299, a),
        819 => radical_inverse(6301, a),
        820 => radical_inverse(6311, a),
        821 => radical_inverse(6317, a),
        822 => radical_inverse(6323, a),
        823 => radical_inverse(6329, a),
        824 => radical_inverse(6337, a),
        825 => radical_inverse(6343, a),
        826 => radical_inverse(6353, a),
        827 => radical_inverse(6359, a),
        828 => radical_inverse(6361, a),
        829 => radical_inverse(6367, a),
        830 => radical_inverse(6373, a),
        831 => radical_inverse(6379, a),
        832 => radical_inverse(6389, a),
        833 => radical_inverse(6397, a),
        834 => radical_inverse(6421, a),
        835 => radical_inverse(6427, a),
        836 => radical_inverse(6449, a),
        837 => radical_inverse(6451, a),
        838 => radical_inverse(6469, a),
        839 => radical_inverse(6473, a),
        840 => radical_inverse(6481, a),
        841 => radical_inverse(6491, a),
        842 => radical_inverse(6521, a),
        843 => radical_inverse(6529, a),
        844 => radical_inverse(6547, a),
        845 => radical_inverse(6551, a),
        846 => radical_inverse(6553, a),
        847 => radical_inverse(6563, a),
        848 => radical_inverse(6569, a),
        849 => radical_inverse(6571, a),
        850 => radical_inverse(6577, a),
        851 => radical_inverse(6581, a),
        852 => radical_inverse(6599, a),
        853 => radical_inverse(6607, a),
        854 => radical_inverse(6619, a),
        855 => radical_inverse(6637, a),
        856 => radical_inverse(6653, a),
        857 => radical_inverse(6659, a),
        858 => radical_inverse(6661, a),
        859 => radical_inverse(6673, a),
        860 => radical_inverse(6679, a),
        861 => radical_inverse(6689, a),
        862 => radical_inverse(6691, a),
        863 => radical_inverse(6701, a),
        864 => radical_inverse(6703, a),
        865 => radical_inverse(6709, a),
        866 => radical_inverse(6719, a),
        867 => radical_inverse(6733, a),
        868 => radical_inverse(6737, a),
        869 => radical_inverse(6761, a),
        870 => radical_inverse(6763, a),
        871 => radical_inverse(6779, a),
        872 => radical_inverse(6781, a),
        873 => radical_inverse(6791, a),
        874 => radical_inverse(6793, a),
        875 => radical_inverse(6803, a),
        876 => radical_inverse(6823, a),
        877 => radical_inverse(6827, a),
        878 => radical_inverse(6829, a),
        879 => radical_inverse(6833, a),
        880 => radical_inverse(6841, a),
        881 => radical_inverse(6857, a),
        882 => radical_inverse(6863, a),
        883 => radical_inverse(6869, a),
        884 => radical_inverse(6871, a),
        885 => radical_inverse(6883, a),
        886 => radical_inverse(6899, a),
        887 => radical_inverse(6907, a),
        888 => radical_inverse(6911, a),
        889 => radical_inverse(6917, a),
        890 => radical_inverse(6947, a),
        891 => radical_inverse(6949, a),
        892 => radical_inverse(6959, a),
        893 => radical_inverse(6961, a),
        894 => radical_inverse(6967, a),
        895 => radical_inverse(6971, a),
        896 => radical_inverse(6977, a),
        897 => radical_inverse(6983, a),
        898 => radical_inverse(6991, a),
        899 => radical_inverse(6997, a),
        900 => radical_inverse(7001, a),
        901 => radical_inverse(7013, a),
        902 => radical_inverse(7019, a),
        903 => radical_inverse(7027, a),
        904 => radical_inverse(7039, a),
        905 => radical_inverse(7043, a),
        906 => radical_inverse(7057, a),
        907 => radical_inverse(7069, a),
        908 => radical_inverse(7079, a),
        909 => radical_inverse(7103, a),
        910 => radical_inverse(7109, a),
        911 => radical_inverse(7121, a),
        912 => radical_inverse(7127, a),
        913 => radical_inverse(7129, a),
        914 => radical_inverse(7151, a),
        915 => radical_inverse(7159, a),
        916 => radical_inverse(7177, a),
        917 => radical_inverse(7187, a),
        918 => radical_inverse(7193, a),
        919 => radical_inverse(7207, a),
        920 => radical_inverse(7211, a),
        921 => radical_inverse(7213, a),
        922 => radical_inverse(7219, a),
        923 => radical_inverse(7229, a),
        924 => radical_inverse(7237, a),
        925 => radical_inverse(7243, a),
        926 => radical_inverse(7247, a),
        927 => radical_inverse(7253, a),
        928 => radical_inverse(7283, a),
        929 => radical_inverse(7297, a),
        930 => radical_inverse(7307, a),
        931 => radical_inverse(7309, a),
        932 => radical_inverse(7321, a),
        933 => radical_inverse(7331, a),
        934 => radical_inverse(7333, a),
        935 => radical_inverse(7349, a),
        936 => radical_inverse(7351, a),
        937 => radical_inverse(7369, a),
        938 => radical_inverse(7393, a),
        939 => radical_inverse(7411, a),
        940 => radical_inverse(7417, a),
        941 => radical_inverse(7433, a),
        942 => radical_inverse(7451, a),
        943 => radical_inverse(7457, a),
        944 => radical_inverse(7459, a),
        945 => radical_inverse(7477, a),
        946 => radical_inverse(7481, a),
        947 => radical_inverse(7487, a),
        948 => radical_inverse(7489, a),
        949 => radical_inverse(7499, a),
        950 => radical_inverse(7507, a),
        951 => radical_inverse(7517, a),
        952 => radical_inverse(7523, a),
        953 => radical_inverse(7529, a),
        954 => radical_inverse(7537, a),
        955 => radical_inverse(7541, a),
        956 => radical_inverse(7547, a),
        957 => radical_inverse(7549, a),
        958 => radical_inverse(7559, a),
        959 => radical_inverse(7561, a),
        960 => radical_inverse(7573, a),
        961 => radical_inverse(7577, a),
        962 => radical_inverse(7583, a),
        963 => radical_inverse(7589, a),
        964 => radical_inverse(7591, a),
        965 => radical_inverse(7603, a),
        966 => radical_inverse(7607, a),
        967 => radical_inverse(7621, a),
        968 => radical_inverse(7639, a),
        969 => radical_inverse(7643, a),
        970 => radical_inverse(7649, a),
        971 => radical_inverse(7669, a),
        972 => radical_inverse(7673, a),
        973 => radical_inverse(7681, a),
        974 => radical_inverse(7687, a),
        975 => radical_inverse(7691, a),
        976 => radical_inverse(7699, a),
        977 => radical_inverse(7703, a),
        978 => radical_inverse(7717, a),
        979 => radical_inverse(7723, a),
        980 => radical_inverse(7727, a),
        981 => radical_inverse(7741, a),
        982 => radical_inverse(7753, a),
        983 => radical_inverse(7757, a),
        984 => radical_inverse(7759, a),
        985 => radical_inverse(7789, a),
        986 => radical_inverse(7793, a),
        987 => radical_inverse(7817, a),
        988 => radical_inverse(7823, a),
        989 => radical_inverse(7829, a),
        990 => radical_inverse(7841, a),
        991 => radical_inverse(7853, a),
        992 => radical_inverse(7867, a),
        993 => radical_inverse(7873, a),
        994 => radical_inverse(7877, a),
        995 => radical_inverse(7879, a),
        996 => radical_inverse(7883, a),
        997 => radical_inverse(7901, a),
        998 => radical_inverse(7907, a),
        999 => radical_inverse(7919, a),
        1000 => radical_inverse(7927, a),
        1001 => radical_inverse(7933, a),
        1002 => radical_inverse(7937, a),
        1003 => radical_inverse(7949, a),
        1004 => radical_inverse(7951, a),
        1005 => radical_inverse(7963, a),
        1006 => radical_inverse(7993, a),
        1007 => radical_inverse(8009, a),
        1008 => radical_inverse(8011, a),
        1009 => radical_inverse(8017, a),
        1010 => radical_inverse(8039, a),
        1011 => radical_inverse(8053, a),
        1012 => radical_inverse(8059, a),
        1013 => radical_inverse(8069, a),
        1014 => radical_inverse(8081, a),
        1015 => radical_inverse(8087, a),
        1016 => radical_inverse(8089, a),
        1017 => radical_inverse(8093, a),
        1018 => radical_inverse(8101, a),
        1019 => radical_inverse(8111, a),
        1020 => radical_inverse(8117, a),
        1021 => radical_inverse(8123, a),
        1022 => radical_inverse(8147, a),
        1023 => radical_inverse(8161, a),
        _ => panic!("radical_inverse_prime: base_index reaches limit"),
    }
}

fn inverse_radical_inverse(base: u32, mut a: u32, n_digits: u32) -> u32 {
    let mut x = 0;
    for _ in 0..n_digits {
        let digit = a % base;
        a /= base;
        x = x * base + digit;
    }
    return x;
}

fn multiplicative_inverse(a: u32, n: u32) -> u32 {
    let (x, _) = extended_gcd(a, n);
    return x.abs() as u32 % n;
}

// Extended Euclidean algorithm
// extended_gcd(a, b) -> (x, y) where
// GCD(a, b) = xa + yb
fn extended_gcd(a: u32, b: u32) -> (i64, i64) {
    if b == 0 {
        return (1, 0);
    } else {
        let d = (a / b) as i64;
        let (xp, yp) = extended_gcd(b, a % b);
        return (yp, xp - (d * yp));
    }
}

fn pos_mod(a: i32, b: i32) -> u32 {
    let m = a % b;
    if m < 0 {
        return (m + b) as u32;
    } else {
        return m as u32;
    }
}

#[cfg(test)]
mod test {
    #[test]
    fn test_radical_inverse_prime() {
        use super::radical_inverse;
        assert_eq!(radical_inverse(10, 0), 0.);
        assert_eq!(radical_inverse(10, 1), 0.1);
        assert_eq!(radical_inverse(10, 1234), 0.4321);
    }
}
